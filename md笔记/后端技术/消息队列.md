# 消息队列

消息队列中间件是分布式系统中最为重要的组件之一，主要用于解决**应用耦合**、**异步消息**和**流量削峰**等问题，是大型分布式系统不可缺少的中间件。消息队列技术是分布式应用间交换信息的一种技术，消息可驻留在内存或者磁盘上，以队列的形式存储信息，直到它们被应用程序消费（Consume）。通过消息队列，应用程序可以相对独立地运行，它们不需要知道彼此的位置，只需要给消息队列发送消息并且处理从消息队列送来的消息。

主要特点：

* 异步处理（**提高系统性能**）
    * 将比较耗时而且不需要同步返回结果的操作作为消息放入消息队列。
    * 削峰、减少相应所需时间
* 降低系统耦合性
    * 只要保持消息格式不变，消息的发送方和接受者并不需要彼此直接联系，也不会受到对方的影响。

目前使用较多的消息队列有 ActiveMQ, RabbitMQ, Kafka, RocketMQ。

队列 Queue 本身是一种先进先出的数据结构，所以消费消息时也是按照顺序来消费的。但是偶尔也会出现消息被消费顺序不同的情况，比如某个消息消费失败，又或者一个 queue 多个 consumer 也会导致消息被消费的顺序不对。使用消息队列，还需要考虑如何保证消息不被重复消费？如何保证消息的可靠性传输（如何处理消息丢失的问题）？

因此，使用消息队列也会让系统可用性降低，复杂度提高，另外需要保障一致性等问题。



## 消息队列常用组件

在 RabbitMQ 中，整个消息队列应用分为下列几个组件：

* 消息生产者（Producer）
* 交换器（Exchange）
* 队列（Queue）
* 消息消费者（Consumer）



## 工作原理

### （1）通过异步处理提高系统性能

在不使用消息队列服务器的时候，用户的请求数据直接写入数据库，在高并发的情况下数据库压力剧增，使得响应速度变慢。但是在使用消息队列之后，用户的请求数据发送给消息队列之后立即 返回，再由消息队列的消费者进程从消息队列中获取数据，异步写入数据库。由于消息队列服务器处理速度快于数据库（消息队列也比数据库有更好的伸缩性），因此响应速度得到大幅改善。

因此可以看出，消息队列具有很好的削峰作用的功能，即通过异步处理，将短时间高并发产生的事务消息存储在消息队列中，从而削平高峰期的并发事务。

虽然用户请求数据写入消息队列之后就立即返回给用户了，但是请求数据在后续的业务校验、写数据库等操作中可能失败。因此使用消息队列进行异步处理之后，需要适当修改业务流程进行配合，比如用户在提交订单之后，订单数据写入消息队列，不能立即返回用户订单提交成功，需要在消息队列的订单消费者进程真正处理完该订单之后，甚至出库后，再通过电子邮件或短信通知用户订单成功，以免交易纠纷。



### （2）降低系统耦合性

消息队列使利用**发布-订阅模式**工作，消息发送者（生产者）发布消息，一个或多个消息接受者（消费者）订阅消息。 消息发送者（生产者）和消息接受者（消费者）之间没有直接耦合，消息发送者将消息发送至分布式消息队列即结束对消息的处理，消息接受者从分布式消息队列获取该消息后进行后续处理，并不需要知道该消息从何而来。对新增业务，只要对该类消息感兴趣，即可订阅该消息，对原有系统和业务没有任何影响，从而实现网站业务的可扩展性设计。如果模块之间不存在直接调用，那么新增模块或者修改模块就对其他模块影响较小，这样系统的可扩展性无疑更好一些。

消息接受者对消息进行过滤、处理、包装后，构造成一个新的消息类型，将消息继续发送出去，等待其他消息接受者订阅该消息。因此**基于事件驱动的业务架构**可以是一系列流程。

另外为了避免消息队列服务器宕机造成消息丢失，会将成功发送到消息队列的消息存储在消息生产者服务器上，等消息真正被消费者服务器处理后才删除消息。在消息队列服务器宕机后，生产者服务器会选择分布式消息队列服务器集群中的其他服务器发布消息。

消息队列不仅仅只能利用发布-订阅模式工作，只是在解耦这个特定业务环境下是使用该模式的，除此之外，还有点对点订阅模式（一个消息只有一个消费者）。这两种消息模型时 JMS 提供的，AMQP 协议还提供了 5 中消息模型。



## 消息队列的不足

* **系统可用性降低：** 系统可用性在某种程度上降低，在引入 MQ 之后，就需要去考虑消息丢失或者说 MQ 挂掉等情况了。
* **系统复杂性提高：** 加入 MQ 之后，需要处理保证消息没有被重复消费，处理消息丢失的情况，保证消息传递的顺序性等情况。
* **一致性问题：**如果消息的真正消费者并没有正确消费消息，这样就可能会导致数据不一致的情况。